name: Build & Deploy Baro Application

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
on:
  pull_request:
    types: [closed]  # PRì´ ë‹«í ë•Œë§Œ íŠ¸ë¦¬ê±°
    branches:
      - develop  # develop ë¸Œëœì¹˜ë¡œì˜ PR


# ì „ì—­ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
env:
  JAVA_VERSION: '17'  # ì‚¬ìš©í•  Java ë²„ì „

jobs:
  # ë¹Œë“œ ì‹¤í–‰ Job (develop ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰)
  build:
    runs-on: ubuntu-latest
    # PRì´ ì‹¤ì œë¡œ ë³‘í•©ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.pull_request.merged == true }}

    steps:
      # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Java í™˜ê²½ ì„¤ì •
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'  # Eclipse Temurin OpenJDK ì‚¬ìš©
          java-version: ${{ env.JAVA_VERSION }}

      # Gradle ì˜ì¡´ì„± ìºì‹± (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # Gradle wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for Gradle
        run: chmod +x gradlew

      # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle
        run: ./gradlew build -x test --no-daemon

      # ë¹Œë“œëœ JAR íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: baro # ê³ ì •ëœ ì´ë¦„
          path: build/libs/*.jar
          retention-days: 3  # 3ì¼ê°„ ë³´ê´€

  # í…ŒìŠ¤íŠ¸ ì„œë²„ ë°°í¬ ì‹¤í–‰ Job (develop ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰)
  deploy-test:
    needs: build  # build job ì™„ë£Œ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest
    # ë³‘í•©ëœ PRì— ëŒ€í•´ì„œë§Œ ë°°í¬ ì§„í–‰ (build í†µê³¼ í›„)
    if: ${{ github.event.pull_request.merged == true }}

    steps:
      # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ë¹Œë“œëœ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: baro
          path: build/libs

      - name: Setup SSH Key (from base64)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TEST_SSH_PRIVATE_KEY_B64 }}" | base64 -d | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # í‚¤ í¬ë§· ê²€ì¦ (ê¹¨ì§€ë©´ ì—¬ê¸°ì„œ ì‹¤íŒ¨)
          ssh-keygen -y -f ~/.ssh/id_ed25519 >/dev/null 2>&1 || { echo "âŒ Invalid private key"; exit 1; }

      - name: Add known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.TEST_SERVER_PORT }}" -H "${{ secrets.TEST_SERVER_HOST }}" >> ~/.ssh/known_hosts

        # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      - name: Test SSH Connection
        run: |
          ssh -p ${{ secrets.TEST_SERVER_PORT }} \
              -o IdentitiesOnly=yes \
              -o StrictHostKeyChecking=yes \
              -i ~/.ssh/id_ed25519 \
              ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} "echo 'SSH Connected to Test Server!'"
      # í…ŒìŠ¤íŠ¸ ì„œë²„ì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
      - name: Deploy to Test Server
        run: |
          # JAR íŒŒì¼ëª… í™•ì¸
          JAR_FILE=$(ls build/libs/*.jar | head -1)
          if [ ! -f "$JAR_FILE" ]; then
            echo "âŒ JAR file not found!"
            exit 1
          fi

          echo "ğŸ“¦ Deploying JAR file to Test Server: $JAR_FILE"

          # í…ŒìŠ¤íŠ¸ ì„œë²„ë¡œ JAR íŒŒì¼ ì „ì†¡
          scp -P ${{ secrets.TEST_SERVER_PORT }} -i ~/.ssh/id_rsa "$JAR_FILE" ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }}:${{ secrets.TEST_DEPLOY_DIR }}/baro-app.jar

          # í…ŒìŠ¤íŠ¸ ì„œë²„ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
          ssh -p ${{ secrets.TEST_SERVER_PORT }} -i ~/.ssh/id_rsa ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} << 'EOF'
            cd ${{ secrets.TEST_DEPLOY_DIR }}

            echo "ğŸ“Œ ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€..."
            docker compose down || echo "No running containers"

            echo "ğŸ“Œ Docker ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -f || echo "No images to remove"

            echo "ğŸ“Œ ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘..."
            docker compose up -d --build

            echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ì„œë²„ ë°°í¬ ìƒíƒœ í™•ì¸..."
            docker compose ps

            echo "ğŸš€ í…ŒìŠ¤íŠ¸ ì„œë²„ ë°°í¬ ì™„ë£Œ!"
          EOF

      # í…ŒìŠ¤íŠ¸ ì„œë²„ ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬
      - name: Test Server Health Check
        run: |
          echo "ğŸ” í…ŒìŠ¤íŠ¸ ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘..."
          sleep 30  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸°

          # Health check ìˆ˜í–‰
          ssh -p ${{ secrets.TEST_SERVER_PORT }} -i ~/.ssh/id_rsa ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} << 'EOF'
            if docker compose ps | grep -q "Up"; then
              echo "âœ… í…ŒìŠ¤íŠ¸ ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            else
              echo "âŒ í…ŒìŠ¤íŠ¸ ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤."
              docker compose logs --tail=50
              exit 1
            fi
          EOF
