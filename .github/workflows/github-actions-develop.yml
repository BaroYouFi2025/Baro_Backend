name: Build & Deploy Baro Application

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
on:
  pull_request:
    types: [closed]  # PRì´ ë‹«í ë•Œë§Œ íŠ¸ë¦¬ê±°
    branches:
      - develop  # develop ë¸Œëœì¹˜ë¡œì˜ PR


# ì „ì—­ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
env:
  JAVA_VERSION: '17'  # ì‚¬ìš©í•  Java ë²„ì „

jobs:
  # ë¹Œë“œ ì‹¤í–‰ Job (develop ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰)
  build:
    runs-on: ubuntu-latest
    # PRì´ ì‹¤ì œë¡œ ë³‘í•©ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ (github.event_name == 'pull_request' && github.event.pull_request.merged == true) }}

    steps:
      # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Java í™˜ê²½ ì„¤ì •
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'  # Eclipse Temurin OpenJDK ì‚¬ìš©
          java-version: ${{ env.JAVA_VERSION }}

      # Gradle ì„¤ì • ë° ìºì‹œ (ì˜ì¡´ì„±/ë˜í¼ ìë™ ìºì‹œ)
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # Gradle wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for Gradle
        run: chmod +x gradlew

      # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build (bootJar)
        run: ./gradlew bootJar -x test --no-daemon

      # ë¹Œë“œëœ JAR íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: baro # ê³ ì •ëœ ì´ë¦„
          path: build/libs/*.jar
          retention-days: 3  # 3ì¼ê°„ ë³´ê´€

  # í…ŒìŠ¤íŠ¸ ì„œë²„ ë°°í¬ ì‹¤í–‰ Job (develop ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰)
  deploy-test:
    needs: build  # build job ì™„ë£Œ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest
    # ë³‘í•©ëœ PRì— ëŒ€í•´ì„œë§Œ ë°°í¬ ì§„í–‰ (build í†µê³¼ í›„)
    if: ${{ (github.event_name == 'pull_request' && github.event.pull_request.merged == true) }}

    steps:
      # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ë¹Œë“œëœ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: baro
          path: build/libs

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.TEST_SSH_PRIVATE_KEY_B64 }}" ]; then
            echo "Using TEST_SSH_PRIVATE_KEY_B64"
            echo "${{ secrets.TEST_SSH_PRIVATE_KEY_B64 }}" | base64 -d | tr -d '\r' > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keygen -y -f ~/.ssh/id_ed25519 >/dev/null 2>&1 || { echo "âŒ Invalid ed25519 private key"; exit 1; }
            echo "SSH_KEY_PATH=$HOME/.ssh/id_ed25519" >> $GITHUB_ENV
          elif [ -n "${{ secrets.TEST_SSH_PRIVATE_KEY }}" ]; then
            echo "Using TEST_SSH_PRIVATE_KEY"
            echo "${{ secrets.TEST_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keygen -y -f ~/.ssh/id_rsa >/dev/null 2>&1 || { echo "âŒ Invalid RSA private key"; exit 1; }
            echo "SSH_KEY_PATH=$HOME/.ssh/id_rsa" >> $GITHUB_ENV
          else
            echo "âŒ No SSH private key secret provided (TEST_SSH_PRIVATE_KEY_B64 or TEST_SSH_PRIVATE_KEY)."
            exit 1
          fi

      - name: Add known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.TEST_SERVER_PORT }}" -H "${{ secrets.TEST_SERVER_HOST }}" >> ~/.ssh/known_hosts

        # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      - name: Test SSH Connection
        run: |
          ssh -p ${{ secrets.TEST_SERVER_PORT }} \
              -o IdentitiesOnly=yes \
              -o StrictHostKeyChecking=yes \
              -i "${{ env.SSH_KEY_PATH }}" \
              ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} "echo 'SSH Connected to Test Server!'"
      # í…ŒìŠ¤íŠ¸ ì„œë²„ì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
      - name: Deploy to Test Server
        run: |
          # JAR íŒŒì¼ëª… í™•ì¸ (build.gradleì˜ bootJar ì„¤ì •ê³¼ ì¼ì¹˜)
          JAR_FILE="build/libs/baro-app.jar"
          if [ ! -f "$JAR_FILE" ]; then
            echo "âŒ JAR file not found!"
            exit 1
          fi

          echo "ğŸ“¦ Deploying JAR file to Test Server: $JAR_FILE"

          # í…ŒìŠ¤íŠ¸ ì„œë²„ë¡œ JAR íŒŒì¼ ì „ì†¡
          scp -P ${{ secrets.TEST_SERVER_PORT }} -i "${{ env.SSH_KEY_PATH }}" "$JAR_FILE" ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }}:${{ secrets.TEST_DEPLOY_DIR }}/baro-app.jar

          # í…ŒìŠ¤íŠ¸ ì„œë²„ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
          ssh -p ${{ secrets.TEST_SERVER_PORT }} -i "${{ env.SSH_KEY_PATH }}" ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} << 'EOF'
            cd ${{ secrets.TEST_DEPLOY_DIR }}

            echo "ğŸ“‹ ë°°í¬ ì „ í™˜ê²½ í™•ì¸..."
            echo "  - ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
            echo "  - JAR íŒŒì¼: $(ls -lh baro-app.jar 2>/dev/null || echo 'Not found yet')"
            echo "  - .env íŒŒì¼: $(test -f .env && echo 'Exists' || echo 'Missing')"

            echo ""
            echo "ğŸ“Œ ê¸°ì¡´ ì•± ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°..."
            docker compose stop app || echo "App container not running"
            docker compose rm -f app || echo "App container not found"

            echo ""
            echo "ğŸ“Œ Docker ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -f || echo "No images to remove"

            echo ""
            echo "ğŸ“Œ PostgreSQL ìƒíƒœ í™•ì¸..."
            docker compose ps postgres

            # PostgreSQLì´ healthy ìƒíƒœì¸ì§€ í™•ì¸
            if docker inspect --format='{{.State.Health.Status}}' youfi-postgres 2>/dev/null | grep -q "healthy"; then
              echo "  âœ… PostgreSQL is healthy"
            else
              echo "  âš ï¸ PostgreSQL is not healthy, waiting..."
              docker compose up -d postgres
              sleep 10
            fi

            echo ""
            echo "ğŸ“Œ ìƒˆë¡œìš´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° ì‹œì‘... (deps ê±´ë“œë¦¬ì§€ ì•ŠìŒ)"
            docker compose up -d --no-deps --build app prometheus grafana

            echo ""
            echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ì„œë²„ ë°°í¬ ìƒíƒœ í™•ì¸..."
            docker compose ps

            echo ""
            echo "ğŸ“¦ ë³¼ë¥¨ í˜„í™© í™•ì¸ (PostgreSQL ë°ì´í„° ìœ ì§€ í™•ì¸)"
            docker volume ls | grep baro || true

            echo ""
            echo "ğŸš€ í…ŒìŠ¤íŠ¸ ì„œë²„ ë°°í¬ ì™„ë£Œ!"
          EOF

      # í…ŒìŠ¤íŠ¸ ì„œë²„ ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬
      - name: Test Server Health Check
        run: |
          echo "ğŸ” í…ŒìŠ¤íŠ¸ ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘..."

          # Health check ìˆ˜í–‰ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          ssh -p ${{ secrets.TEST_SERVER_PORT }} -i "${{ env.SSH_KEY_PATH }}" ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} << 'EOF'
            cd ${{ secrets.TEST_DEPLOY_DIR }}

            echo "ğŸ“Š í˜„ì¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker compose ps

            echo ""
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ healthcheck ëŒ€ê¸° ì¤‘ (ìµœëŒ€ 2ë¶„)..."

            # ìµœëŒ€ 120ì´ˆ ë™ì•ˆ 10ì´ˆ ê°„ê²©ìœ¼ë¡œ health check í™•ì¸
            MAX_ATTEMPTS=12
            ATTEMPT=1

            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "  ì‹œë„ $ATTEMPT/$MAX_ATTEMPTS..."

              # Docker healthcheck ìƒíƒœ í™•ì¸
              HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' baro-app 2>/dev/null || echo "no-healthcheck")

              if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ healthy ìƒíƒœì…ë‹ˆë‹¤!"

                # ì¶”ê°€ ê²€ì¦: actuator endpoint ì§ì ‘ í™•ì¸
                echo "ğŸ” Actuator health endpoint í™•ì¸ ì¤‘..."
                if docker exec baro-app wget -qO- http://localhost:10080/actuator/health | grep -q '"status":"UP"'; then
                  echo "âœ… Actuator health check ì„±ê³µ!"
                  echo ""
                  echo "ğŸ“Š ìµœì¢… ìƒíƒœ:"
                  docker compose ps app
                  exit 0
                else
                  echo "âš ï¸ Actuator health check ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘..."
                fi
              elif [ "$HEALTH_STATUS" = "unhealthy" ]; then
                echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ unhealthy ìƒíƒœì…ë‹ˆë‹¤."
                echo ""
                echo "ğŸ“‹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ (ë§ˆì§€ë§‰ 100ì¤„):"
                docker compose logs --tail=100 app
                echo ""
                echo "ğŸ” Health check ì‹¤íŒ¨ ì›ì¸:"
                docker inspect --format='{{range .State.Health.Log}}{{.Output}}{{end}}' baro-app || echo "Health log not available"
                exit 1
              else
                echo "  ìƒíƒœ: $HEALTH_STATUS (ëŒ€ê¸° ì¤‘...)"
                sleep 10
              fi

              ATTEMPT=$((ATTEMPT + 1))
            done

            # íƒ€ì„ì•„ì›ƒ
            echo "âŒ Health check íƒ€ì„ì•„ì›ƒ (2ë¶„ ì´ˆê³¼)"
            echo ""
            echo "ğŸ“Š í˜„ì¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker compose ps
            echo ""
            echo "ğŸ“‹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ (ë§ˆì§€ë§‰ 100ì¤„):"
            docker compose logs --tail=100 app
            exit 1
          EOF
